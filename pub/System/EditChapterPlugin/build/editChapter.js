"use strict";!function(e){e(document).on("click",".ecpEdit",(function(){var t=e(this),i=(t.attr("href"),e.extend({id:t.parent().attr("id"),title:t.attr("title")},t.data()));return e.jsonRpc(foswiki.getScriptUrl("jsonrpc"),{namespace:"EditChapterPlugin",method:"lock",params:{topic:i.web+"."+i.topic}}).done((function(){foswiki.loadTemplate({name:"edit.chapter",expand:"dialog",topic:i.web+"."+i.topic,baseweb:i.baseWeb,basetopic:i.baseTopic,from:i.from,to:i.to,title:i.title,id:i.id,t:(new Date).getTime()}).done((function(i){var n=e(i.expand);n.hide(),e("body").append(n),n.data("autoOpen",!0).on("dialogopen",(function(){t.trigger("opened")}))}))})).fail((function(t,i,n){var o=t.responseJSON;void 0===o?e.pnotify({title:"Error",text:"undefined error message",type:"error"}):e.pnotify({title:"Error",text:o.error.message,type:"error"})})),!1})),e(".ecpForm").livequery((function(){var t=e(this),i=t.find("input[name='topic']").val(),n=t.parent(),o=!1;n.on("dialogclose",(function(){e.jsonRpc(foswiki.getScriptUrl("jsonrpc"),{namespace:"EditChapterPlugin",method:"unlock",params:{topic:i},error:function(e,t,i){console&&console.error(e.error.message)}}),n.dialog("destroy").remove()})),n.on("dialogresize",(function(i,o){var r=t.find(".natedit").data("natedit");if(r){var a=r.container,d=n,c=n.find(".ui-natedit-toolbar"),s=d.height()-c.height()-a.position().top;"function"==typeof r.setSize?r.setSize(void 0,s):e(r.txtarea).height(s)}})),t.on("submit",(function(){var e=t.find(".natedit").data("natedit");if(!o){if(o=!0,void 0===e)n();else{var i=e.beforeSubmit();void 0!==i?i.then(n):n()}return!1}function n(){var i,n,o,r=t.find("[name=beforetext]"),a=t.find("[name=aftertext]"),d=t.find("[name=chapter]"),c=t.find("[name=text]");if(!r.length||!a.length||!d.length)return!1;"\n"!=(i=d.val()).substr(i.length-1,1)&&(i+="\n"),e.engine&&"wysiwyg"===e.engine.type?(n="<div class='WYSIWYG_PROTECTED'>"+r.val()+"</div>",o="<div class='WYSIWYG_PROTECTED'>"+a.val()+"</div>"):(n=r.val(),o=a.val()),c.val(n+i+o),t.trigger("submit")}o=!1})),window.setTimeout((function(){n.dialog({position:{my:"center",at:"center",of:window}})}))}))}(jQuery);
